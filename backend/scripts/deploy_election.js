const { ethers, run, network } = require("hardhat");
let cassandra = require('cassandra-driver');
require("dotenv").config()

async function deploy_contract() {
  client = get_db_conn()
  const abi = [
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_electionName",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "duration_minutes",
          "type": "uint256"
        }
      ],
      "stateMutability": "payable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "string",
          "name": "message",
          "type": "string"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "sender",
          "type": "address"
        }
      ],
      "name": "ErrorMessage",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_imageUrl",
          "type": "string"
        }
      ],
      "name": "addCandidate",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_candidateIndex",
          "type": "uint256"
        }
      ],
      "name": "addVote",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "candidates",
      "outputs": [
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "imageUrl",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "voteCount",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "date_ends",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "date_starts",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "electionName",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getRemainingTime",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getVotingStatus",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "numberCandidates",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
  const bytecode = "0x6080604052604051620017b8380380620017b8833981810160405281019062000029919062000287565b33600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600090816200007b91906200052e565b5060028054905060018190555042600481905550603c816200009e919062000644565b42620000ab91906200068f565b6005819055505050620006ca565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6200012282620000d7565b810181811067ffffffffffffffff82111715620001445762000143620000e8565b5b80604052505050565b600062000159620000b9565b905062000167828262000117565b919050565b600067ffffffffffffffff8211156200018a5762000189620000e8565b5b6200019582620000d7565b9050602081019050919050565b60005b83811015620001c2578082015181840152602081019050620001a5565b60008484015250505050565b6000620001e5620001df846200016c565b6200014d565b905082815260208101848484011115620002045762000203620000d2565b5b62000211848285620001a2565b509392505050565b600082601f830112620002315762000230620000cd565b5b815162000243848260208601620001ce565b91505092915050565b6000819050919050565b62000261816200024c565b81146200026d57600080fd5b50565b600081519050620002818162000256565b92915050565b60008060408385031215620002a157620002a0620000c3565b5b600083015167ffffffffffffffff811115620002c257620002c1620000c8565b5b620002d08582860162000219565b9250506020620002e38582860162000270565b9150509250929050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200034057607f821691505b602082108103620003565762000355620002f8565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620003c07fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000381565b620003cc868362000381565b95508019841693508086168417925050509392505050565b6000819050919050565b60006200040f6200040962000403846200024c565b620003e4565b6200024c565b9050919050565b6000819050919050565b6200042b83620003ee565b620004436200043a8262000416565b8484546200038e565b825550505050565b600090565b6200045a6200044b565b6200046781848462000420565b505050565b5b818110156200048f576200048360008262000450565b6001810190506200046d565b5050565b601f821115620004de57620004a8816200035c565b620004b38462000371565b81016020851015620004c3578190505b620004db620004d28562000371565b8301826200046c565b50505b505050565b600082821c905092915050565b60006200050360001984600802620004e3565b1980831691505092915050565b60006200051e8383620004f0565b9150826002028217905092915050565b6200053982620002ed565b67ffffffffffffffff811115620005555762000554620000e8565b5b62000561825462000327565b6200056e82828562000493565b600060209050601f831160018114620005a6576000841562000591578287015190505b6200059d858262000510565b8655506200060d565b601f198416620005b6866200035c565b60005b82811015620005e057848901518255600182019150602085019450602081019050620005b9565b86831015620006005784890151620005fc601f891682620004f0565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600062000651826200024c565b91506200065e836200024c565b92508282026200066e816200024c565b9150828204841483151762000688576200068762000615565b5b5092915050565b60006200069c826200024c565b9150620006a9836200024c565b9250828201905080821115620006c457620006c362000615565b5b92915050565b6110de80620006da6000396000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c8063581c281c11610066578063581c281c1461014957806385e8e7a7146101675780638da5cb5b14610185578063c19f32fa146101a3578063efb98bcf146101c15761009e565b80630383badc146100a357806326541b56146100bf5780633477ee2e146100db57806349bb0ec11461010d57806351fe73fd1461012b575b600080fd5b6100bd60048036038101906100b8919061077b565b6101df565b005b6100d960048036038101906100d491906108ee565b610375565b005b6100f560048036038101906100f0919061077b565b61049a565b604051610104939291906109f4565b60405180910390f35b6101156105e4565b6040516101229190610a39565b60405180910390f35b6101336105ea565b6040516101409190610a39565b60405180910390f35b6101516105f0565b60405161015e9190610a6f565b60405180910390f35b61016f61060a565b60405161017c9190610a8a565b60405180910390f35b61018d610698565b60405161019a9190610aed565b60405180910390f35b6101ab6106be565b6040516101b89190610a39565b60405180910390f35b6101c96106c4565b6040516101d69190610a39565b60405180910390f35b600033905060011515600660008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615150361028e573373ffffffffffffffffffffffffffffffffffffffff167f32069f510f3441e08281829ccd350e21359f64024ffae7e4e64dab4df2cfc7e360405161028090610b7a565b60405180910390a250610372565b60028054905082106102d5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102cc90610be6565b60405180910390fd5b6000600283815481106102eb576102ea610c06565b5b9060005260206000209060030201905060018160020160008282546103109190610c64565b925050819055506001600660008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050505b50565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610405576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103fc90610d0a565b60405180910390fd5b6000604051806060016040528084815260200183815260200160008152509050600281908060018154018082558091505060019003906000526020600020906003020160009091909190915060008201518160000190816104669190610f36565b50602082015181600101908161047c9190610f36565b50604082015181600201555050600280549050600181905550505050565b600281815481106104aa57600080fd5b90600052602060002090600302016000915090508060000180546104cd90610d59565b80601f01602080910402602001604051908101604052809291908181526020018280546104f990610d59565b80156105465780601f1061051b57610100808354040283529160200191610546565b820191906000526020600020905b81548152906001019060200180831161052957829003601f168201915b50505050509080600101805461055b90610d59565b80601f016020809104026020016040519081016040528092919081815260200182805461058790610d59565b80156105d45780601f106105a9576101008083540402835291602001916105d4565b820191906000526020600020905b8154815290600101906020018083116105b757829003601f168201915b5050505050908060020154905083565b60015481565b60045481565b60006004544210158015610605575060055442105b905090565b6000805461061790610d59565b80601f016020809104026020016040519081016040528092919081815260200182805461064390610d59565b80156106905780601f1061066557610100808354040283529160200191610690565b820191906000526020600020905b81548152906001019060200180831161067357829003601f168201915b505050505081565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60055481565b600060045442101561070b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161070290611054565b60405180910390fd5b600554421061071d576000905061072e565b4260055461072b9190611074565b90505b90565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b61075881610745565b811461076357600080fd5b50565b6000813590506107758161074f565b92915050565b6000602082840312156107915761079061073b565b5b600061079f84828501610766565b91505092915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6107fb826107b2565b810181811067ffffffffffffffff8211171561081a576108196107c3565b5b80604052505050565b600061082d610731565b905061083982826107f2565b919050565b600067ffffffffffffffff821115610859576108586107c3565b5b610862826107b2565b9050602081019050919050565b82818337600083830152505050565b600061089161088c8461083e565b610823565b9050828152602081018484840111156108ad576108ac6107ad565b5b6108b884828561086f565b509392505050565b600082601f8301126108d5576108d46107a8565b5b81356108e584826020860161087e565b91505092915050565b600080604083850312156109055761090461073b565b5b600083013567ffffffffffffffff81111561092357610922610740565b5b61092f858286016108c0565b925050602083013567ffffffffffffffff8111156109505761094f610740565b5b61095c858286016108c0565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b60005b838110156109a0578082015181840152602081019050610985565b60008484015250505050565b60006109b782610966565b6109c18185610971565b93506109d1818560208601610982565b6109da816107b2565b840191505092915050565b6109ee81610745565b82525050565b60006060820190508181036000830152610a0e81866109ac565b90508181036020830152610a2281856109ac565b9050610a3160408301846109e5565b949350505050565b6000602082019050610a4e60008301846109e5565b92915050565b60008115159050919050565b610a6981610a54565b82525050565b6000602082019050610a846000830184610a60565b92915050565b60006020820190508181036000830152610aa481846109ac565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610ad782610aac565b9050919050565b610ae781610acc565b82525050565b6000602082019050610b026000830184610ade565b92915050565b7f416e206572726f72206f636375727265643a20796f75206861766520616c726560008201527f61647920766f7465640000000000000000000000000000000000000000000000602082015250565b6000610b64602983610971565b9150610b6f82610b08565b604082019050919050565b60006020820190508181036000830152610b9381610b57565b9050919050565b7f496e76616c69642063616e64696461746520696e6465782e0000000000000000600082015250565b6000610bd0601883610971565b9150610bdb82610b9a565b602082019050919050565b60006020820190508181036000830152610bff81610bc3565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610c6f82610745565b9150610c7a83610745565b9250828201905080821115610c9257610c91610c35565b5b92915050565b7f6f6e6c7920746865206f776e65722063616e206d616b6520746869732061637460008201527f696f6e0000000000000000000000000000000000000000000000000000000000602082015250565b6000610cf4602383610971565b9150610cff82610c98565b604082019050919050565b60006020820190508181036000830152610d2381610ce7565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610d7157607f821691505b602082108103610d8457610d83610d2a565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610dec7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610daf565b610df68683610daf565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610e33610e2e610e2984610745565b610e0e565b610745565b9050919050565b6000819050919050565b610e4d83610e18565b610e61610e5982610e3a565b848454610dbc565b825550505050565b600090565b610e76610e69565b610e81818484610e44565b505050565b5b81811015610ea557610e9a600082610e6e565b600181019050610e87565b5050565b601f821115610eea57610ebb81610d8a565b610ec484610d9f565b81016020851015610ed3578190505b610ee7610edf85610d9f565b830182610e86565b50505b505050565b600082821c905092915050565b6000610f0d60001984600802610eef565b1980831691505092915050565b6000610f268383610efc565b9150826002028217905092915050565b610f3f82610966565b67ffffffffffffffff811115610f5857610f576107c3565b5b610f628254610d59565b610f6d828285610ea9565b600060209050601f831160018114610fa05760008415610f8e578287015190505b610f988582610f1a565b865550611000565b601f198416610fae86610d8a565b60005b82811015610fd657848901518255600182019150602085019450602081019050610fb1565b86831015610ff35784890151610fef601f891682610efc565b8355505b6001600288020188555050505b505050505050565b7f566f74696e6720686173206e6f742073746172746564207965742e0000000000600082015250565b600061103e601b83610971565b915061104982611008565b602082019050919050565b6000602082019050818103600083015261106d81611031565b9050919050565b600061107f82610745565b915061108a83610745565b92508282039050818111156110a2576110a1610c35565b5b9291505056fea2646970667358221220d1942d670ab6e587a4dc72fd610cec55e2247f999f0e42b7048dbec247150a8d64736f6c63430008180033";

  const provider = new ethers.JsonRpcProvider(process.env.ALCHEMY_API_KEY)

  const wallet = new ethers.Wallet(process.env.TESTNET_PRIVATE_KEY, provider);
  const query = `SELECT duration_minutes, election_name
              FROM election.poll
              WHERE user_public_key = '${wallet.address.toLowerCase()}'
              ORDER BY last_update_timestamp DESC
              LIMIT 1 ALLOW FILTERING;`
  try {
    const result = await client.execute(query);

    const poll_name = result.rows[0].election_name;
    const poll_duration = result.rows[0].duration_minutes;
    const Election = new ethers.ContractFactory(abi, bytecode, wallet)
    const el_contract = await Election.deploy(poll_name, poll_duration);
    const receipt = await el_contract.deploymentTransaction().wait(2);
    const contractAddress = receipt.contractAddress
    const res = await verifyContract(contractAddress, [poll_name, poll_duration]);
    console.log(`election contract will be deployed to address: ${contractAddress}`);
    console.log(`receipt for the contract deployment: ${receipt}`)
    if (!res) {
      throw new Error('Contract not varified.');
    }
    return contractAddress
  } catch (error) {
    console.error('Error executing query:', error);
  } finally {
    await closeConnection(client);
  }

  return contractAddress
}


function get_db_conn() {
  const keyspace = "election";
  let contactPoints = ['0.0.0.0'];
  let client = new cassandra.Client({
    contactPoints: contactPoints,
    keyspace: keyspace, localDataCenter:
      'datacenter1'
  });

  return client

}


async function main() {


  return deploy_contract()

}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});

async function closeConnection(client) {
  if (client) {
    return client.shutdown()
      .then(() => console.log('Cassandra connection closed.'))
      .catch(err => console.error('Error closing Cassandra connection:', err));
  } else {
    console.log('No active Cassandra connection to close.');
  }
}


async function verifyContract(address, args) {
  console.log("Verifying contract...");
  try {
    await run("verify:verify", {
      address: address,
      constructorArguments: args,
    });
    console.log("Contract verified successfully.");
    return true
  } catch (error) {
    if (error.message.toLowerCase().includes("already verified")) {
      console.log("Contract is already verified.");
      return true
    } else {
      console.error("Verification failed:", error);
      return false
    }
  }
}